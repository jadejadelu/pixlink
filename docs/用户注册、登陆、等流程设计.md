
### 服务端组件架构

```
├── pix-server (API网关+业务逻辑)
│   ├── auth-service (认证授权)
│   ├── room-service (房间管理)
│   ├── tunnel-service (隧道协调)
│   └── user-service (用户管理)
├── ztm-hub (ZTM核心组件)
└── ztm-controller (隧道管理，本质是ztm-agent，使用root用户接入的特殊agent)
```

### 客户端组件架构

```
├── pix-gui (Tauri桌面应用)
│   ├── ui-layer (Vue3界面)
│   ├── biz-layer (业务逻辑)
│   └── tunnel-layer (隧道管理)
└── ztm-agent (仅负责网络连接)
```

## 组件交互REST API设计

### 用户注册

#### 1. pix-gui ↔ pix-server (Public API)

```
POST /api/v1/auth/register
Content-Type: application/json

Request:
{
  "username": "player123",
  "password": "hashed_password",
  "nickname": "玩家昵称",
  "email": "user@example.com"
}

Response:
{
  "success": true,
  "data": {
    "userId": "uuid",
    "username": "player123"
  }
}
```

### 用户登陆

### 第一步：用户认证

```
Component: pix-gui → pix-server
API: POST /api/v1/auth/login

Request:
POST /api/v1/auth/login
Content-Type: application/json

{
  "username": "player123",
  "password": "hashed_password"
}

Response:
{
  "success": true,
  "data": {
    "userId": "user_uuid",
    "username": "player123",
    "token": "jwt_token",
    "nextAction": "upload_identity",
    "uploadUrl": "/api/v1/auth/upload-identity"
  }
}

Error Response:
{
  "success": false,
  "error": {
    "code": "AUTH_FAILED",
    "message": "Invalid username or password"
  }
}
```

### 第二步：获取ZTM Identity文件内容

```
Component: pix-gui → ztm-agent
API: GET http://localhost:7777/api/identity

Request:
GET http://localhost:7777/api/identity

Response:
Content-Type: text/plain
Body: "identity_content_here"  // 纯文本，直接就是identity内容
```

### 第三步：上传加密的Identity文件

```
Component: pix-gui → pix-server
API: POST /api/v1/auth/upload-identity

Request:
POST /api/v1/auth/upload-identity
Headers: Authorization: Bearer {token}
Content-Type: application/json

{
  "userId": "user_uuid",
  "encryptedIdentity": "base64_aes_gcm_encrypted_identity_content",
  "encryptionNonce": "12_byte_nonce_base64",
  "identityChecksum": "sha256_checksum_of_original_identity",
  "timestamp": "current_timestamp"
}

Response:
{
  "success": true,
  "data": {
    "certificateId": "cert_uuid",
    "nextAction": "generate_certificate"
  }
}





```

### 第四步：pix-server调用ztm-controller创建用户证书（关键步骤）

```
Component: pix-server → ztm-controller (ZTM root agent)
API: POST /api/meshes/{meshName}/permits/{username}

Request:
POST /api/meshes/default-mesh/permits/player123
Headers: 
  Content-Type: application/json


Response:
{
  "certificate": "-----BEGIN CERTIFICATE-----\n...\n-----END CERTIFICATE-----",
  "privateKey": "-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----",
  "certificateId": "cert_uuid"
}



curl -v  POST http://localhost:7777/api/meshes/ztm-hub:8888/permits/testuser -H "Content-Type: text/plain" -d "-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA337wrCBAdQqLcKCvWEt5
myQpL0DdGBwnMmJAN0tt6vSGtT39C8Bo6zOrbTBuMHl6Dklw6XdkwF++0JNcrh8v
QzmASZJ0dxhgMeXbn9QIHjkwb8Jx5GdTc4OeglU4VefrOWZDVf4PKsSVb5+9bXY8
GB4iJ6SVHxMZuEeLyFExWG/0Sdeh+/wvQLuOptP4IGT0eooQ9dQifcMNEbnzb5lf
JNoHvMyS/f/H3HLxXFbOXMDq1mTvhRMVXOqK+Uk4BgNldEcpY2V2RoHn1fy0hL5q
ssB1XNAXSoSmWdD8OYEpvGlFw3vPX47lQwuBXpXNY9iicYX5lmFHDzBxIitFfqKx
rQIDAQAB
-----END PUBLIC KEY-----"


```

### 第五步：pix-server返回加密证书给pix-gui

```
Component: pix-server → pix-gui
API: Response from /api/v1/auth/upload-identity

Response:
{
  "success": true,
  "data": {
    "certificateId": "cert_uuid",
    "encryptedCertificate": "base64_aes_gcm_encrypted_certificate_content",
    "encryptionNonce": "12_byte_nonce_base64",
    "ztmConfig": {
      "hubEndpoint": "wss://hub.pixlink.local:8000",
      "hubId": "hub_uuid",
      "username": "player123",
      "certificateId": "cert_uuid"
    },
    "nextAction": "import_certificate"
  }
}
```

### 第六步：将证书配置应用到ztm-agent 

```
Component: pix-gui → ztm-agent
API: PUT /api/meshes/{meshName}

Request:
PUT /api/meshes/default-mesh
Content-Type: application/json

{
  "name": "default-mesh",
  "ca": "-----BEGIN CERTIFICATE-----\n...\n-----END CERTIFICATE-----",  // CA证书
  "agent": {
    "certificate": "-----BEGIN CERTIFICATE-----\n...\n-----END CERTIFICATE-----",  // 用户证书
    "privateKey": "-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----",  // 私钥
    "id": "agent_uuid",
    "name": "player123",
    "offline": false
  },
  "bootstraps": ["hub.pixlink.local:8000"]
}

Response:
HTTP Status: 200 OK
{
  "name": "default-mesh",
  "ca": "-----BEGIN CERTIFICATE-----\n...\n-----END CERTIFICATE-----",
  "agent": {
    "id": "agent_uuid",
    "name": "player123",
    "username": "player123",
    "certificate": "-----BEGIN CERTIFICATE-----\n...\n-----END CERTIFICATE-----",
    "labels": [],
    "offline": false
  },
  "bootstraps": ["hub.pixlink.local:8000"],
  "connected": true,
  "errors": []
}
```