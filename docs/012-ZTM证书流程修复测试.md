# 012-ZTM证书流程修复测试

## 测试时间
2026-02-15 20:09

## 测试目的
验证基于HAR文件分析的ZTM证书流程修复，包括：
1. ZTM permit创建API调用格式修复
2. 客户端导入permit到mesh的API调用格式修复
3. 邮件发送逻辑更新，发送完整的permit JSON文件
4. 前端导航逻辑修复，防止自动返回登录页

## 测试环境
- 服务端：http://localhost:3000
- 客户端：http://localhost:5173
- ZTM Root Agent：http://localhost:7777
- ZTM Local Agent：http://localhost:7778
- ZTM Hub：ztm-hub:8888
- 数据库：MySQL (Docker)

## 测试账户
- 邮箱：172296329@qq.com
- 用户名：jade
- 密码：123456
- 设备ID：device_test_001

## 测试步骤

### 1. 用户注册
**请求：**
```bash
curl -X POST http://localhost:3000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "172296329@qq.com",
    "password": "123456",
    "nickname": "jade"
  }'
```

**预期结果：**
- 返回成功响应
- 用户状态为PENDING
- 需要激活账户

**实际结果：**
```json
{
  "success": true,
  "data": {
    "user": {
      "id": "104c5f8f-8ee5-4d19-b41d-765e9f21f885",
      "email": "172296329@qq.com",
      "nickname": "jade",
      "status": "PENDING",
      "createdAt": "2026-02-15T12:07:06.576Z"
    },
    "session": null,
    "requiresActivation": true
  }
}
```

**状态：✅ 通过**

### 2. 账户激活
**操作：** 直接在数据库中将用户状态改为ACTIVE（模拟激活流程）

**状态：✅ 通过**

### 3. 用户登录
**请求：**
```bash
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "172296329@qq.com",
    "password": "123456",
    "deviceId": "device_test_001"
  }'
```

**预期结果：**
- 返回JWT token
- nextAction为"upload_identity"
- 自动创建设备记录

**实际结果：**
```json
{
  "success": true,
  "data": {
    "user": {
      "id": "104c5f8f-8ee5-4d19-b41d-765e9f21f885",
      "email": "172296329@qq.com",
      "nickname": "jade",
      "status": "ACTIVE"
    },
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "nextAction": "upload_identity",
    "uploadUrl": "/api/auth/upload-identity"
  }
}
```

**状态：✅ 通过**

### 4. 上传Identity文件
**请求：**
```bash
curl -X POST http://localhost:3000/api/auth/upload-identity \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <JWT_TOKEN>" \
  -d '{
    "encryptedIdentity": "encrypted_{...}",
    "encryptionNonce": "nonce_123",
    "identityChecksum": "checksum_123",
    "timestamp": "2026-02-15T12:07:00.000Z"
  }'
```

**预期结果：**
- 成功上传identity
- 调用ZTM root agent创建permit
- 返回certificateId
- nextAction为"send_permit"

**实际结果：**
```json
{
  "success": false,
  "error": "Failed to create ZTM permit: Failed to create ZTM permit: 403"
}
```

**状态：❌ 失败 - ZTM API权限问题**

### 5. ZTM API测试
**测试ZTM root agent连接：**
```bash
curl -X GET http://localhost:7777/api/meshes
```

**结果：**
```json
[{
  "name": "ztm-hub:8888",
  "ca": "-----BEGIN CERTIFICATE-----\n...",
  "agent": {
    "id": "c4fd5d12-a5ad-480c-be5b-9c481a6a086f",
    "name": "agent",
    "username": "root"
  },
  "bootstraps": ["ztm-hub:8888"]
}]
```

**状态：✅ 通过**

**测试ZTM permit创建：**
```bash
curl -X POST http://localhost:7777/api/meshes/ztm-hub:8888/permits/testuser123 \
  -H "Content-Type: text/plain" \
  -d "-----BEGIN PUBLIC KEY-----\n...\n-----END PUBLIC KEY-----"
```

**结果：**
```
HTTP/1.1 403 Forbidden
```

**状态：❌ 失败 - ZTM API返回403 Forbidden**

## 代码修复总结

### 1. ZTM permit创建API调用格式修复
**文件：** `/Users/jade/pixlink/pixlink-server/src/services/ztmService.ts`

**修复内容：**
- API调用格式已经正确（Content-Type: text/plain）
- 响应解析已更新为提取data.agent.certificate

**状态：✅ 已修复**

### 2. 客户端导入permit到mesh的API调用格式修复
**文件：** `/Users/jade/pixlink/pixlink-client/src/services/ztmService.ts`

**修复内容：**
- 将API端点从`/api/meshes/${this.meshName}/permits`改为`/api/meshes/mesh`
- 匹配HAR文件中的正确API调用格式

**状态：✅ 已修复**

### 3. 邮件发送逻辑更新
**文件：** `/Users/jade/pixlink/pixlink-server/src/controllers/authController.ts`

**修复内容：**
- 从ZTM root agent获取CA证书
- 构造完整的permit JSON文件，包含ca、agent、bootstraps字段
- 发送完整的permit JSON而不是仅证书

**状态：✅ 已修复**

### 4. 前端导航逻辑修复
**文件：**
- `/Users/jade/pixlink/pixlink-client/src/components/ImportPermit.vue`
- `/Users/jade/pixlink/pixlink-client/src/App.vue`

**修复内容：**
- 将ImportPermit组件的goToDashboard()从页面重载改为事件发射
- 在App.vue中添加handleImportPermitSuccess()处理函数
- 防止自动返回登录页

**状态：✅ 已修复**

### 5. 其他修复
**文件：** `/Users/jade/pixlink/pixlink-server/src/controllers/authController.ts`

**修复内容：**
- 修复ZTM用户名生成，移除重复的"device_"前缀
- 修复uploadIdentity接口的userId验证逻辑
- 修复证书创建时的userId引用

**状态：✅ 已修复**

## 当前问题

### ZTM API权限问题
**问题描述：**
ZTM root agent API返回403 Forbidden错误，无法创建permit。

**可能原因：**
1. ZTM root agent配置了CORS或其他安全机制
2. 只允许来自其web界面（Origin: http://localhost:7777）的请求
3. PixLink服务器从不同端口（3000）发起请求被拒绝

**测试结果：**
- ✅ GET /api/meshes - 成功
- ❌ POST /api/meshes/ztm-hub:8888/permits/{username} - 403 Forbidden

**建议解决方案：**
1. 检查ZTM root agent的配置文件，调整CORS设置
2. 配置ZTM root agent允许来自PixLink服务器的请求
3. 使用代理或中间件来处理跨域请求
4. 考虑使用ZTM的CLI工具或SDK替代直接API调用

## 测试结论

### 成功的修复
1. ✅ 用户注册流程正常
2. ✅ 账户激活流程正常（手动激活）
3. ✅ 用户登录流程正常，包含设备自动创建
4. ✅ 前端导航逻辑修复完成
5. ✅ 邮件发送逻辑更新完成
6. ✅ 客户端API调用格式修复完成

### 待解决的问题
1. ❌ ZTM root agent API权限问题（403 Forbidden）
2. ⏳ 需要配置ZTM root agent允许外部API调用
3. ⏳ 需要完成完整的端到端测试

## 下一步行动
1. 联系ZTM root agent管理员或检查配置文件
2. 配置ZTM root agent的CORS或安全设置
3. 完成完整的用户注册→登录→上传identity→创建permit→发送邮件→导入permit→加入mesh流程测试
4. 清理测试数据库

## 备注
- 所有代码修复已完成并部署
- 测试环境正常运行
- ZTM API权限问题是当前的主要阻碍
- 建议优先解决ZTM API权限问题以完成完整流程测试